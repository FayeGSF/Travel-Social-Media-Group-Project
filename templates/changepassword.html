{% extends 'userbase.html' %}

{% block title %} Change Password {% endblock %}

{# Set the active page to be highlighted in the navigation bar. #}
{% set active_page = 'changepassword' %}

{% block content %}
<section class="container py-2 text-left">
    <script>
        function validatepassword(event){
          // Getting all values from the the form
          var password = document.getElementById('password').value;
          var confirmPassword = document.getElementById('confirmpassword').value;
          var oldpassword = document.getElementById('oldpassword').value;
          var passwordError = document.getElementById('password_error');
          var confirmPasswordError = document.getElementById('confirm_password_error');
          
          // Resetting error messages and removing 'is-invalid' class
          passwordError.textContent = '';
          confirmPasswordError.textContent = '';
          document.getElementById('password').classList.remove('is-invalid');
          document.getElementById('confirmpassword').classList.remove('is-invalid');
          // Checking if password and confirm password values are they same
          if (password !== confirmPassword) {
            confirmPasswordError.textContent = 'Passwords do not match.';
            document.getElementById('confirmpassword').classList.add('is-invalid');
            event.preventDefault();
            return false;
          }
          // Checking if the new password is the same as the old password
          if (password == oldpassword){
            passwordError.textContent = 'New password cannot be same as old password';
            document.getElementById('password').classList.add('is-invalid');
            event.preventDefault();
            return false;
          }
          // Checking if the new password is less than 8 characters
          if (password.length < 8){
            passwordError.textContent = 'Password must be longer than 8 characters';
            document.getElementById('password').classList.add('is-invalid');
            event.preventDefault();
            return false;
          }
          // Checking if the password contains at least one number
          if (!/\d/.test(password)) {
            passwordError.textContent = 'Password must contain at least one number';
            document.getElementById('password').classList.add('is-invalid');
            event.preventDefault();
            return false;
          }

          // Checking if the password contains at least one uppercase letter
          if (!/[A-Z]/.test(password)) {
            passwordError.textContent = 'Password must contain at least one uppercase letter';
            document.getElementById('password').classList.add('is-invalid');
            event.preventDefault();
            return false;
          }

          // Checking if the password contains at least one special character
          if (!/[!@#$%^&*()_+\-=\[\]{}|;:'",.<>\/?]/.test(password)) {
            passwordError.textContent = 'Password must contain at least one special character';
            document.getElementById('password').classList.add('is-invalid');
            event.preventDefault();
            return false;
          }

          return true;
        }
    </script>
    <div class="row  justify-content-center mt-3">
        <div class="col-lg-6 bg-white p-5 rounded-3">
            <div class="gap-3 w-200" >
                <h2  class=" text-center">Change Your Password</h2>
                <div class=" d-flex justify-content-end align-items-center gap-2" style="width: 80%;">
                    {% with message = get_flashed_messages() %}
                        {% if message %}
                            <!--Displaying the Flash Message-->
                            <div class="alert alert-success" role="alert" id="flashMessage">
                                {{ message[0]|capitalize }}
                            </div>
                            <script>
                                // Setting the timeout for the flash message to disappear after 1.5 seconds
                                setTimeout(function() {
                                    var flashMessage = document.getElementById("flashMessage");
                                    if (flashMessage) {
                                        flashMessage.style.display = "none";
                                    }
                                }, 1500); 
                            </script>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
            <div class="d-flex justify-content-center p-4">
                <form action="{{ url_for('profile.updatepassword') }}" method="POST" style="width: 100%; max-width: 600px;" onsubmit="return validatepassword(event)">
                    <div class="mb-4">
                        <label for="oldpassword" class="form-label">Enter Your Old Password</label>
                        <input type="password" class="form-control" id="oldpassword" name="oldpassword" value="">
                        <div id="oldpassword_error" class="invalid-feedback"></div>
                    </div>
                    <div class=" mb-4">
                        <label for="password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="password" name="password" value="" placeholder="Enter New Password">
                        <div id="passwordHelp" class="form-text">Your new password must be atleast 8 characters long.</div>
                        <div id="password_error" class="invalid-feedback"></div>
                    </div>
                    <div class=" mb-4">
                        <label for="confirmpassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmpassword" name="confirmpassword" value="" placeholder="Renter New Password">
                        <div id="confirm_password_error" class="invalid-feedback"></div>
                    </div>
                    <div class="d-flex justify-content-between w-100">
                        <a href="{{ url_for('profile.profile') }}" class="btn btn-secondary px-4 w-50 ">Cancel</a>
                        <button type="submit" class="btn btn-primary px-4 w-50 ms-4">Submit</button>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
    <script>
        // variable to track old password validation
        let isOldPasswordValid = false; 
    
        function validatepassword(event) {
            var password = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirmpassword').value;
            var oldpassword = document.getElementById('oldpassword').value;
            var passwordError = document.getElementById('password_error');
            var confirmPasswordError = document.getElementById('confirm_password_error');
            var oldPasswordError = document.getElementById('oldpassword_error');
    
            // Resetting error messages
            passwordError.textContent = '';
            confirmPasswordError.textContent = '';
            oldPasswordError.textContent = '';
    
            document.getElementById('password').classList.remove('is-invalid');
            document.getElementById('confirmpassword').classList.remove('is-invalid');
            document.getElementById('oldpassword').classList.remove('is-invalid');
    
            // Checking if the old password is valid
            if (!isOldPasswordValid) {
                oldPasswordError.textContent = 'Old password is incorrect.';
                document.getElementById('oldpassword').classList.add('is-invalid');
                event.preventDefault();
                return false;
            }
    
            // Checking if the passwords match
            if (password !== confirmPassword) {
                confirmPasswordError.textContent = 'Passwords do not match.';
                document.getElementById('confirmpassword').classList.add('is-invalid');
                event.preventDefault();
                return false;
            }
    
            // Check if the new password is the same as the old password
            if (password == oldpassword) {
                passwordError.textContent = 'New password cannot be the same as the old password.';
                document.getElementById('password').classList.add('is-invalid');
                event.preventDefault();
                return false;
            }
    
            // Checking if the new password is less than 8 characters
            if (password.length < 8) {
                passwordError.textContent = 'Password must be at least 8 characters long.';
                document.getElementById('password').classList.add('is-invalid');
                event.preventDefault();
                return false;
            }
            // Checking if the new password contains atleast 1 digit
            if (!/\d/.test(password)) {
                passwordError.textContent = 'Password must contain at least one number.';
                document.getElementById('password').classList.add('is-invalid');
                event.preventDefault();
                return false;
            }
            // Checking if the new password contains atleaast 1 Capital letter
            if (!/[A-Z]/.test(password)) {
                passwordError.textContent = 'Password must contain at least one uppercase letter.';
                document.getElementById('password').classList.add('is-invalid');
                event.preventDefault();
                return false;
            }
            // Checking if the new password contains atleast 1 Special character
            if (!/[!@#$%^&*()_+\-=\[\]{}|;:'",.<>\/?]/.test(password)) {
                passwordError.textContent = 'Password must contain at least one special character.';
                document.getElementById('password').classList.add('is-invalid');
                event.preventDefault();
                return false;
            }
    
            return true;
        }
    
        document.addEventListener("DOMContentLoaded", function() {
            let oldpasswordField = document.getElementById("oldpassword");
            if (oldpasswordField) {
                oldpasswordField.addEventListener("input", function() {
                    let oldpassword = this.value.trim();
                    let oldPasswordError = document.getElementById("oldpassword_error");
    
                    if (oldpassword === "") {
                        oldPasswordError.textContent = "";
                        this.classList.remove("is-invalid", "is-valid");
                        isOldPasswordValid = false;
                        return;
                    }
    
                    // AJAX request to check old password validity
                    fetch("/check-oldpassword", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ oldpassword: oldpassword }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.Correct_Password) {
                            oldPasswordError.textContent = "Old password is correct.";
                            this.classList.remove("is-invalid");
                            this.classList.add("is-valid");
                            isOldPasswordValid = true;
                        } else {
                            oldPasswordError.textContent = "Old password is incorrect.";
                            this.classList.add("is-invalid");
                            isOldPasswordValid = false;
                        }
                    })
                    .catch(error => console.error("Error:", error));
                });
            }
        });
    </script>
    
   
</section>
{% endblock %}