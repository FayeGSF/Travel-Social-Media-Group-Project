{% extends 'userbase.html' %}

{% block title %}Discovery{% endblock %}

{% set active_page = 'discover' %}

{% block content %}
<!-- Alert message to confirm journey has been found or error message-->
{% with messages = get_flashed_messages(with_categories=True) %}
{% if messages %}
    {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}
{% endwith %} 

<style>
    .hover-border-primary:hover {
        border: 2px solid #397bbd !important; 
    }
</style>

<section class="container py-4 ">
    <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 mb-4">
        <div>
            <h5 class="text-secondary ms-1 ">Discovery Journeys</h5>
        </div>

        <div class="d-flex ms-md-auto align-items-center gap-3" >
            <input id="search" class="form-control rounded-2 border-0 shadow-none w-30" placeholder="Search by title/description">
            <!-- <select id="statusFilter" class="form-select w-auto">
                <option value="" {% if request.args.get('status', '') == '' %}selected{% endif %}>All</option>
                <option value="public" {% if request.args.get('status', '') == 'public' %}selected{% endif %}>Public</option>
                <option value="private" {% if request.args.get('status', '') == 'private' %}selected{% endif %}>Private</option>
            </select> -->
            <button class="btn btn-primary" onclick="searchJourneys()" style=" width: 150px;">Search</button>
            <a href="/discover" class="btn border text-secondary text-nowrap">Clear Search</a>

        </div>
    </div>


    <!-- <div class="container">
        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Status</th>
                    <th>Journey ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Start Date</th>
                    <th>Last Edited</th>
                    <th>Action</th>
                    <th>View journey</th>
                </tr>
            </thead>
            <tbody id="journeyTableBody">
                {% for journey in public_journeys %}
                <tr>
                    <td style="width:6em;">
                        <span class="badge {% if journey.status == 'public' %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ journey.status | capitalize }}
                        </span>
                    </td>
                    <td>{{ journey.journey_id }}</td>  
                    <td>{{ journey.title }}</td>
                    <td>{{ journey.description }}</td>
                    <td>{{ journey.start_date.strftime("%d-%m-%Y") }}</td>
                    <td>{{ journey.last_edited.strftime("%d-%m-%Y %H:%M:%S") }}</td>
                    <td>
                        <select class="status-select form-select form-select-sm" data-journey-id="{{ journey.journey_id }}">
                            <option value="Public" {% if journey.status == 'public' %}selected{% endif %}>Public</option>
                            <option value="Private" {% if journey.status == 'private' %}selected{% endif %}>Private</option>
                        </select>
                    </td>
                    <td>
                        <a href="/journey/{{ journey.journey_id }}" class="btn btn-primary btn-sm">View Journey</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center text-muted no_issues_text">
                        <i>No journeys found!</i>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div> -->

    <div class="row g-3 " id="journeyCards">
        {% if public_journeys %}
            {% for journey in public_journeys %}
                {% if journey.event_image %}
                    <div class="col-12 col-md-6">
                        <div class="card border-0 rounded-2">
                            <a href="{{ url_for('myjourneys.view_journey', journey_id=journey.journey_id,from=request.path) }}" class="text-decoration-none d-block">
                                <img src="{{ url_for('static', filename=journey.event_image.replace('static/', '')) }}" style="height: 250px; object-fit: cover; object-position: center;" class="card-img w-100" alt="...">
                                <div class="card-img-overlay d-flex flex-column hover-border-primary ">
                                    <h5 class="card-title text-white ms-2" style="text-shadow: 2px 2px 5px rgba(0,0,0,0.5);">
                                        {% if journey.status == 'public' %}
                                        <span class="me-1"><img src="/static/images/gongkai-2.png" alt="" style="width:20px;"></span>
                                        {% else %}
                                        <span class="me-1"><img src="/static/images/yincang.png" alt="" style="width:20px;"></span>
                                        {% endif %}
                                        {{journey.title}}
                                    </h5>
                                    <p class="card-text mb-1 text-white ms-2" style="text-shadow: 2px 2px 5px rgba(0,0,0,0.5);" >{{journey.description}}</p>
                                    <p class="card-text text-white ms-2 mb-1" style="text-shadow: 2px 2px 5px rgba(0,0,0,0.5);"><small>{{journey.start_date.strftime('%d-%m-%Y')}}</small></p>
                                    <span class="text-white"><img src="/static/images/location.png" style="width:20px;" alt="">{{journey.location}}</span>
                                </div>
                            </a>
                        </div>
                    </div>
                    

                {% else %}
                    <div class="col-12 col-md-6">
                        <a href="{{ url_for('myjourneys.view_journey', journey_id=journey.journey_id,from=request.path) }}" class="text-decoration-none d-block">
                            <div class="card border-0 rounded-2  p-3 shadow-sm hover-border-primary" style="height: 250px;">
                                <h4 class="card-title text-dark ms-1" >
                                    {% if journey.status == 'public' %}
                                        <span class="me-1"><img src="/static/images/gongkai.png" alt="" style="width:20px;"></span>
                                    {% else %}
                                        <span class="me-1"><img src="/static/images/yincang.png" alt="" style="width:20px;"></span>
                                    {% endif %}
                                    {{journey.title}}
                                </h4>
                                <p class="card-text mb-1 text-dark ms-2" >{{journey.description}}</p>
                                <p class="card-text text-secondary ms-2 mb-1"><small>{{journey.start_date.strftime('%d-%m-%Y')}}</small></p>
                                <span class="text-secondary"><img src="/static/images/location-2.png" style="width:20px;" alt="">{{journey.location}}</span>
                            </div>
                        </a>
                    </div>
                
                {% endif %}
            {% endfor %}
        {% else %}
            <div>
                <div class="bg-white shadow-sm rounded-3 p-5 mb-3">
                    <h4 class="text-center text-secondary">No journeys found! ðŸ˜•.</h4>
                </div>
            </div>
        {% endif%}
    </div>
    
</section>

<script>
    function searchJourneys() {
        const searchQuery = document.getElementById('search').value;
        const statusFilterElement = document.getElementById('statusFilter');
        const statusFilter = statusFilterElement ? statusFilterElement.value : '';
        const queryParams = new URLSearchParams({ search: searchQuery });
        
        fetch(`/discover?search=${encodeURIComponent(searchQuery)}&status=${statusFilter}`)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newCards = doc.querySelector("#journeyCards");
                document.getElementById("journeyCards").innerHTML = newCards.innerHTML;
                attachStatusChangeListeners();  //  update the page
            });
    }

    // function confirmToggle(journeyId, currentStatus) {
    //     if (!journeyId) {
    //         console.error("Error: journeyId is missing");
    //         return;
    //     }
    //     if (confirm(`Are you sure you want to change this journey to ${currentStatus === 'public' ? 'private' : 'public'}?`)) {
    //         toggleVisibility(journeyId, currentStatus);
    //     }
    // }

    // document.querySelectorAll('.status-select').forEach(select => {
    //     select.addEventListener('change', function() {
    //         const journeyId = this.getAttribute('data-journey-id');
    //         const newStatus = this.value;

    //         fetch('/toggle_visibility', {  
    //             method: "POST",
    //             headers: { "Content-Type": "application/json" },
    //             body: JSON.stringify({ journey_id: journeyId, new_status: newStatus })
    //         })
    //         .then(response => response.json().then(data => ({ status: response.status, body: data })))
    //         .then(result => {
    //             if (result.status === 200) {
    //                 alert("Journey status updated successfully!");
    //                 window.location.reload();
    //             } else {
    //                 console.error("Toggle failed:", result.body);
    //                 alert("Error: " + (result.body.error || "Unknown error"));
    //             }
    //         })
    //         .catch(error => {
    //             console.error("Fetch Error:", error);
    //             alert("Network error: Could not update journey status.");
    //         });
    //     });
    // });
</script>

{% endblock %}
