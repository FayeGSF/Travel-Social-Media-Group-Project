{% extends "userbase.html" %}

{% block title %}Edit Event{% endblock %}

{% block content %}
<!-- Flash message -->
{% with messages = get_flashed_messages(with_categories=True) %}
{% if messages %}
    {% for category, message in messages %}
        <div class="container alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}
{% endwith %}
<div class="container mt-4">
    <a href="{{ url_for('myjourneys.view_journey', journey_id=event.journey_id) }}" class="mb-3 d-inline-block">
        &lt;&lt; Back to Journey
    </a>
    
    <h2>Edit Event</h2>
    
    <div class="row">
        <div class="col-md-8">
            <form method="POST" action="{{ url_for('myjourneys.edit_event', event_id=event.event_id) }}">
                <div class="mb-3">
                    <label for="title" class="form-label">Event Title*</label>
                    <input type="text" class="form-control" id="title" name="title" 
                           value="{{ form_data.title if form_data else event.title }}" required>
                </div>
                
                <div class="mb-3">
                    <label for="location" class="form-label">Location*</label>
                    <input
                        list="locations-list"
                        class="form-control"
                        id="location"
                        name="location"
                        value="{{ form_data.location if form_data else event.location }}"
                        placeholder="Type or select a location"
                        required
                    />
                    <datalist id="locations-list">
                        {% for existing_location in locations %}
                            <option value="{{ existing_location['location'] }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="3">{{ form_data.description if form_data else event.description }}</textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="start_date" class="form-label">Start Date*</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ form_data.start_date if form_data else event.start_date|string }}" 
                               max="{{ current_date }}"
                               required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="start_time" class="form-label">Start Time (Optional)</label>
                        <input type="time" class="form-control" id="start_time" name="start_time" 
                               value="{{ form_data.start_time if form_data else event.start_time|string }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="end_date" class="form-label">End Date (Optional)</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ form_data.end_date if form_data else event.end_date|string }}"
                               max="{{ current_date }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="end_time" class="form-label">End Time (Optional)</label>
                        <input type="time" class="form-control" id="end_time" name="end_time" 
                               value="{{ form_data.end_time if form_data else event.end_time|string }}">
                        <small class="form-text text-muted">Leave blank if it's a single-moment event</small>
                    </div>
                </div>
                
                <div class="mb-3 form-text">
                    * Required fields
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <a href="{{ url_for('myjourneys.view_journey', journey_id=event.journey_id) }}" class="btn btn-secondary">Cancel</a>
                    
                    <form method="POST" action="{{ url_for('myjourneys.delete_event', event_id=event.event_id) }}" 
                          onsubmit="return confirm('Are you sure you want to delete this event? This action cannot be undone and all associated photos will be permanently removed.');"
                          class="d-inline">
                        <button type="submit" class="btn btn-danger">Delete Event</button>
                    </form>
                </div>
            </form>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Event Photo</h5>
                    {% if event.event_image %}
                        <img src="{{ url_for('static', filename=event.event_image) }}" 
                             class="card-img-top mb-3" alt="Event photo">
                        {% if session.get('user_id') == event.journey_user_id or (session.get('role') in ['editor', 'admin'] and journey_status == 'public') %}
                        <form method="POST" action="{{ url_for('myjourneys.remove_event_photo', event_id=event.event_id) }}" 
                              onsubmit="return confirm('Are you sure you want to remove this photo?');">
                            <button type="submit" class="btn btn-danger w-100">Remove Photo</button>
                        </form>
                        {% endif %}
                    {% else %}
                        <p class="card-text">No photo uploaded yet.</p>
                        {% if session.get('user_id') == event.journey_user_id %}
                            <form method="POST" action="{{ url_for('myjourneys.add_photo', event_id=event.event_id) }}" 
                                  enctype="multipart/form-data" class="mt-3">
                                <div class="mb-3">
                                    <label for="photo" class="form-label">Upload Photo</label>
                                    <input type="file" class="form-control" id="photo" name="photo" accept="image/*" required>
                                    <div class="form-text">Max size: 5MB. Allowed formats: JPG, PNG, GIF</div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Upload Photo</button>
                            </form>
                        {% else %}
                            <div class="alert alert-info">
                                Only the journey owner can upload photos.
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 