{% extends "userbase.html" %}

{% block title %}Journey Details{% endblock %}

{% block content %}
<!-- Flash message for add_photo and add_event has been created -->
{% with messages = get_flashed_messages(with_categories=True) %}
{% if messages %}
    {% for category, message in messages %}
        <div class="container alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}
{% endwith %}

<div class="container mt-4">
    <a href="{{ from_page }}" class=""> &lt;&lt; Exit</a>
    <div class="container bg-white shadow-sm p-5 rounded-2 my-4">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h4 class="mt-0 mb-3">{{ journey['title'] |capitalize}}</h4>
                <p>{{ journey['description']|capitalize }}</p>
            </div>
            <div class="d-flex gap-2">
                {% if session.get('user_id') == journey['user_id'] or (session.get('role') in ['editor', 'admin'] and journey['status'] == 'public') %}
                <a href="{{ url_for('myjourneys.edit_journey', journey_id=journey.journey_id) }}" 
                   class="btn btn-outline-secondary">
                    <i class="bi bi-pencil"></i> Edit Journey
                </a>
                <button class="btn btn-outline-danger delete-journey-btn" 
                        data-journey-id="{{ journey.journey_id }}">
                    <i class="bi bi-trash"></i> Delete Journey
                </button>
                {% endif %}
            </div>
        </div>
        <div class="row mb-2">
            <div class="col">
                <strong>Location:</strong> {{ journey['location'] |capitalize }}
            </div>
            <div class="col">
                <strong>Start Date:</strong> {{ journey['start_date'] }}
            </div>
            <div class="col">
                <strong>Status:</strong> {{ journey['status']|capitalize }}
            </div>
        </div>
        {% if session.get('user_id') == journey['user_id'] %}
        <div class='d-flex align-items-center mt-3'>
            <strong class="me-3">Set journey status: </strong>
            <select class="status-select form-select form-select-sm" data-journey-id="{{ journey.journey_id }}" style="width:150px">
                <option value="Public" {% if journey.status == 'public' %}selected{% endif %}>Public</option>
                <option value="Private" {% if journey.status == 'private' %}selected{% endif %}>Private</option>
            </select>
        </div>
        {% endif %}
    </div>
    <!-- Show the Events heading for all users but add event button only for journey owner -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">Events on this journey</h4>
        {% if session.get('user_id') == journey['user_id'] %}
        <a href="{{ url_for('myjourneys.add_event', journey_id=journey['journey_id'],from=request.path) }}" class="btn btn-primary">Add New Event</a>
        {% endif %}
    </div>
    {% if events %}
        <div class="row" data-masonry='{"percentPosition": true }' id="event-grid">
            {% for event in events %}
                <div class="col-md-4 mb-4">
                    <div class="card" >
                        {% if event['event_image'] %}
                            <div class="position-relative">
                                <img src="{{ url_for('static', filename=event['event_image']) }}" 
                                     class="card-img-top" alt="Event photo"> 
                                <span class="position-absolute top-0 end-0 badge bg-primary m-2">
                                    <i class="bi bi-camera-fill"></i>
                                </span>
                            </div>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ event['title'] }}
                                {% if event['has_photos'] %}
                                <i class="bi bi-camera-fill text-primary ms-1" title="This event has photos"></i>
                                {% endif %}
                            </h5>
                            <div class="d-flex justify-content-between mb-2">
                                <h6 class="card-subtitle text-muted">{{ event['location'] }}</h6>
                                <small class="text-muted">{{ event['start_date'] }}</small>
                            </div>
                            {% if event['description'] and '[Photo was removed by site staff for content review. ]' in event['description'] %}
                                <div class="alert alert-warning mb-2">
                                    <i class="bi bi-exclamation-triangle"></i> Photo was removed by site staff for content review.
                                </div>
                                <p class="card-text">{{ event['description'].replace('[Photo was removed by site staff for content review. ]', '') }}</p>
                            {% else %}
                                <p class="card-text">{{ event['description'] }}</p>
                            {% endif %}
                            <p>
                                <strong>Start Date:</strong> {{ event['start_date'] }}<br>
                                {% if event['end_date'] and event['end_date'] != event['start_date'] %}
                                    <strong>End Date:</strong> {{ event['end_date'] }}
                                {% endif %}
                            </p>
                            
                            <div class="d-flex gap-2">
                                {% if not event['event_image'] and session.get('user_id') == journey['user_id'] %}
                                    <a href="{{ url_for('myjourneys.add_photo', event_id=event['event_id']) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-camera"></i> Add Photo
                                    </a>
                                {% endif %}

                                {% if event['event_image'] and (session.get('user_id') == journey['user_id'] or (session.get('role') in ['editor', 'admin'] and journey['status'] == 'public')) %}
                                    <button class="btn btn-sm btn-outline-danger delete-photo-btn" 
                                            data-event-id="{{ event['event_id'] }}">
                                        <i class="bi bi-trash"></i> Remove Photo
                                    </button>
                                {% endif %}

                                {% if session.get('user_id') == journey['user_id'] or (session.get('role') in ['editor', 'admin'] and journey['status'] == 'public') %}
                                    <a href="{{ url_for('myjourneys.edit_event', event_id=event['event_id']) }}" 
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil"></i> Edit Event
                                    </a>
                                    
                                    <button class="btn btn-sm btn-outline-danger delete-event-btn" 
                                            data-event-id="{{ event['event_id'] }}">
                                        <i class="bi bi-trash"></i> Delete Event
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info text-center p-4 mb-4">
            <h5 class="mb-2"><i class="bi bi-info-circle me-2"></i>This journey has no events yet</h5>
            <p>Travel events help document the highlights of your journey.</p>
            {% if session.get('user_id') == journey['user_id'] %}
            <a href="{{ url_for('myjourneys.add_event', journey_id=journey['journey_id'],from=request.path) }}" 
               class="btn btn-primary mt-2">
               <i class="bi bi-plus-circle me-1"></i>Add Your First Event
            </a>
            {% endif %}
        </div>
    {% endif %}
    

</div>

<script>
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function() {
            const journeyId = this.getAttribute('data-journey-id');
            const newStatus = this.value;

            fetch('/toggle_visibility', {  
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ journey_id: journeyId, new_status: newStatus })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(result => {
                if (result.status === 200) {
                    alert("Journey status updated successfully!");
                    window.location.reload();
                } else {
                    console.error("Toggle failed:", result.body);
                    alert("Error: " + (result.body.error || "Unknown error"));
                }
            })
            .catch(error => {
                console.error("Fetch Error:", error);
                alert("Network error: Could not update journey status.");
            });
        });
    });

    // Add event listeners for delete photo buttons
    document.querySelectorAll('.delete-photo-btn').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this photo?')) {
                const eventId = this.getAttribute('data-event-id');
                
                fetch(`/delete_photo/${eventId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        window.location.reload();
                    } else {
                        alert(data.error || 'Error deleting photo');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting photo');
                });
            }
        });
    });

    // Add event listeners for delete event buttons
    document.querySelectorAll('.delete-event-btn').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this event? This action cannot be undone and all associated photos will be permanently removed.')) {
                const eventId = this.getAttribute('data-event-id');
                
                fetch(`/api/event/${eventId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        window.location.reload();
                    } else {
                        alert(data.error || 'Error deleting event');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting event');
                });
            }
        });
    });

    // Add event listener for delete journey button
    document.querySelector('.delete-journey-btn')?.addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this journey?\n\nThis action will:\n- Delete all events in this journey\n- Remove all associated photos\n- Cannot be undone')) {
            const journeyId = this.getAttribute('data-journey-id');
            
            fetch(`/api/journey/${journeyId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    window.location.href = '/myjourneys';
                } else {
                    alert(data.error || 'Error deleting journey');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting journey');
            });
        }
    });
    

</script>
<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var grid = document.querySelector('#event-grid');

        if (grid) {
            imagesLoaded(grid, function () {
                new Masonry(grid, {
                    itemSelector: '.col-md-4',
                    percentPosition: true
                });
            });
        }
    });

</script>



{% endblock %}
