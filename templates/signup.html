{% extends 'userbase.html' %}

{% block title %}Signup{% endblock %}

{# Set the active page to be highlighted in the navigation bar. #}
{% set active_page = 'signup' %}

{% block content %}
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Wanderlog Sign Up</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      // Function to validate the password before submitting the form
      function validatepassword(event){
        var password = document.getElementById('password').value;
        var confirmPassword = document.getElementById('confirmpassword').value;
        var passwordError = document.getElementById('password_error');
        var confirmPasswordError = document.getElementById('confirm_password_error');
        
        // Resetting error messages and removing 'is-invalid' class
        passwordError.textContent = '';
        confirmPasswordError.textContent = '';
        document.getElementById('password').classList.remove('is-invalid');
        document.getElementById('confirmpassword').classList.remove('is-invalid');
        
        // Checking if the password and conform password is the same
        if (password !== confirmPassword) {
          confirmPasswordError.textContent = 'Passwords do not match.';
          document.getElementById('confirmpassword').classList.add('is-invalid');
          event.preventDefault();
          return false;
        }

        // Checking if the length of the password is shorter than 8 characters
        if (password.length < 8){
          passwordError.textContent = 'Password must be longer than 8 characters';
          document.getElementById('password').classList.add('is-invalid');
          event.preventDefault();
          return false;
        }

        // Checking if the password contains at least one number
        if (!/\d/.test(password)) {
          passwordError.textContent = 'Password must contain at least one number';
          document.getElementById('password').classList.add('is-invalid');
          event.preventDefault();
          return false;
        }

        // Checking if the password contains at least one uppercase letter
        if (!/[A-Z]/.test(password)) {
          passwordError.textContent = 'Password must contain at least one uppercase letter';
          document.getElementById('password').classList.add('is-invalid');
          event.preventDefault();
          return false;
        }

        // Checking if the password contains at least one special character
        if (!/[!@#$%^&*()_+\-=\[\]{}|;:'",.<>\/?]/.test(password)) {
          passwordError.textContent = 'Password must contain at least one special character';
          document.getElementById('password').classList.add('is-invalid');
          event.preventDefault();
          return false;
        }


        return true;
      }

     
    </script>
    
    <div class="vw-90">
      <div class="row vh-80  align-items-center justify-content-center">
        <div class="col-md-auto col-lg-5 col-xl-4">
            <div class=" text-white border border-bottom-0 rounded-top text-center bg-primary" >
                <h1 class="p-3 m-0">Sign up</h1>
            </div>
            <div class="bg-white border container">
                <form class="p-3" action="{{ url_for('auth.signup') }}" method="post" onsubmit="return validatepassword(event)">
                  <div class="row">
                    <div class="col-md-6">
                  <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control{% if username_error %} is-invalid{% endif %}" id="username" name="username" placeholder="Choose a username..." maxlength=20 value="{{ username }}" required>
                    <div id="username_error" class="invalid-feedback">{{ username_error }}</div>
                  </div>
                  <div class="mb-3">
                    <label for="email" class="form-label">Email Address</label>
                    <input type="email" class="form-control{% if email_error %} is-invalid{% endif %}" id="email" name="email" placeholder="Enter your email address..." maxlength=320 value="{{ email }}" required>
                    <div id="email_error" class="invalid-feedback">{{ email_error }}</div>
                  </div>
                  <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control{% if password_error %} is-invalid{% endif %}" id="password" name="password" placeholder="Choose a password..." aria-describedby="passwordHelp" required>
                    <div id="passwordHelp" class="form-text">Your password must be at least 8 characters long.</div>
                    <div id="password_error" class="invalid-feedback">{{ password_error }}</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="confirmpassword" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control{% if confirm_password_error %} is-invalid{% endif %}" id="confirmpassword" name="confirmpassword" placeholder="Confirm your password..." aria-describedby="passwordHelp" required>
                    <div id="confirm_password_error" class="invalid-feedback">{{ confirm_password_error }}</div>
                  </div>
                  <div class="mb-3">
                    <label for="first_name" class="form-label">First Name</label>
                    <input type="first_name" class="form-control{% if first_name_error %} is-invalid{% endif %}" id="first_name" name="first_name" placeholder="Enter your first name.." aria-describedby="passwordHelp" required>
                    <div id="first_name_error" class="invalid-feedback">{{ first_name_error }}</div>
                  </div>
                  <div class="mb-3">
                    <label for="last_name" class="form-label">Last Name</label>
                    <input type="last_name" class="form-control{% if last_name_error %} is-invalid{% endif %}" id="last_name" name="last_name" placeholder="Enter your last name.." aria-describedby="passwordHelp" required>
                    <div id="last_name_error" class="invalid-feedback">{{ last_name_error }}</div>
                  </div>
                </div>
                </div>
                  <div class="text-center">
                    <button type="submit" class="btn btn-primary" >Sign Up</button>
                  </div>
                </form>
            </div>
            {% if signup_successful %}
            <div class="bg-success text-white border border-top-0 rounded-bottom text-center">
                <div class="p-2">You have successfully signed up! <a class="link-light" href="{{ url_for('auth.login') }}">Log in</a></div>
            </div>
            {% else %}
            <div class="bg-white border border-top-0 rounded-bottom text-center">
                <div class="p-2">Already have an account? <a href="{{ url_for('auth.login') }}">Log in</a></div>
            </div>
            {% endif %}
        </div>
      </div>
    </div>
  </body>
  <script defer>
    // Function to check if the username is valid as the user types it
    document.addEventListener("DOMContentLoaded", function() {
        let usernameField = document.getElementById("username");
        let emailField = document.getElementById("email");
        if (usernameField) {
            usernameField.addEventListener("input", function() {
                let username = this.value.trim();
                let usernameError = document.getElementById("username_error");
    
                if (username === "") {
                    usernameError.textContent = "";
                    this.classList.remove("is-invalid");
                    return;
                }

                // AJAX request to access backend function to check if
                // username is unique
    
                fetch("/check-username", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username: username }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.is_unique) {
                        usernameError.textContent = "";
                        this.classList.remove("is-invalid");
                        this.classList.add("is-valid");
                    } else {
                        usernameError.textContent = "Username is already taken.";
                        this.classList.add("is-invalid");
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        }
        if (emailField) {
            emailField.addEventListener("input", function() {
                let email = this.value.trim();
                let emailError = document.getElementById("email_error");
    
                if (email === "") {
                    emailError.textContent = "";
                    this.classList.remove("is-invalid");
                    return;
                }

                // AJAX request to access backend function to check if
                // email is unique
    
                fetch("/check-email", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: email }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.is_unique) {
                        emailError.textContent = "";
                        this.classList.remove("is-invalid");
                        this.classList.add("is-valid");
                    } else {
                        emailError.textContent = "Email is already taken.";
                        this.classList.add("is-invalid");
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        }
    });
    </script>
    
{% endblock %}

