{% extends 'userbase.html' %}

{% block title %}Users Page{% endblock %}

{% set active_page = 'users' %}

{% block content %}
<section class="container py-4 text-left">
    <div class="container col-md-12 bg-white border shadow-sm rounded-3 p-5">
        <div class="row justify-content-between align-items-center gy-3 mb-3">
            <div class="col-auto">
                <h3 class="text-dark mb-0">
                    User Roles Overview
                </h3>
                <p class="mb-0 text-muted fst-italic">Travellers: {{ roles_num.traveller }} | Editors: {{ roles_num.editor }} | Admins: {{ roles_num.admin }}</p>
            </div>
        
        </div>
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <div class="col-auto d-flex align-items-center mb-3 mb-md-0">
                <p class="me-2 mb-0 text-muted">Filter By:</p>
                <div class="btn-group">
                    <a href="?filter=all" class="btn btn-outline-primary flex-fill text-nowrap {% if filter_status == 'all' %}active{% endif %}">All</a>
                    <a href="?filter=traveller" class="btn btn-outline-primary flex-fill text-nowrap {% if filter_status == 'traveller' %}active{% endif %}">Traveller</a>
                    <a href="?filter=editor" class="btn btn-outline-primary flex-fill text-nowrap {% if filter_status == 'editor' %}active{% endif %}">Editor</a>
                    <a href="?filter=admin" class="btn btn-outline-primary flex-fill text-nowrap {% if filter_status == 'admin' %}active{% endif %}">Admin</a>
                </div>
            </div>
            <div class=" d-flex justify-content-end">
                <div class="input-group" style="max-width: 330px;">
                    <input type="text" id="userSearch" class="form-control" placeholder="Search users..." oninput="searchUsers()">
                    <button class="btn btn-primary" onclick="searchUsers()">Search</button>
                </div>
            </div>
        </div>
            
    
    <div class="mt-4">
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr class="text-center">
                            <th>Avatar</th>
                            <th>Role</th>
                            <th>Username</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users_filtered %}
                            <tr class="text-center">
                                <td>                                    
                                    <img src="{{ user.profile_image }}"
                                    class="rounded-circle img-fluid" 
                                    alt="Profile Picture" 
                                    style="width: 30px; height: 30px;">
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if user.role == 'traveller' %} bg-primary
                                        {% elif user.role == 'editor' %} bg-success
                                        {% elif user.role == 'admin' %} bg-danger
                                        {% endif %}">
                                        {{ user.role | capitalize }}
                                    </span>
                                </td>
                                <td>{{user.username}}</td>
                                <td>{{user.first_name | capitalize}}</td>
                                <td>{{user.last_name | capitalize}}</td>
                                <td>{{user.email}}</td>
                                <td>
                                    <span class="badge 
                                        {% if user.status == 'active' %} bg-success
                                        {% elif user.status == 'banned' %} bg-danger
                                        {% elif user.status == 'blocked' %} bg-secondary
                                        {% endif %}">
                                        {{ user.status | capitalize }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('users.userprofile', userid=user.user_id) }}" class="btn btn-light btn-md">View Profile</a>
                                </td>
                            </tr>
                        {% endfor %}
                        
                        {% if users_filtered|length == 0 %}
                        <tr>
                            <td colspan="8" class="text-center text-muted">No users found matching your search criteria.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<script>
function searchUsers() {
    let input = document.getElementById("userSearch").value.toLowerCase();
    let table = document.querySelector("table tbody");
    let rows = table.getElementsByTagName("tr");

    for (let row of rows) {
        let username = row.cells[2]?.textContent.toLowerCase() || "";
        let firstName = row.cells[3]?.textContent.toLowerCase() || "";
        let lastName = row.cells[4]?.textContent.toLowerCase() || "";
        let fullName = (firstName + " " + lastName).trim();
        let email = row.cells[5]?.textContent.toLowerCase() || "";

        if (username.includes(input) || firstName.includes(input) || lastName.includes(input) || fullName.includes(input) || email.includes(input)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}
</script>

{% endblock %}
